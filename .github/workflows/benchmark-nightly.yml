name: Nightly Benchmarks

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:     # Manual trigger
  pull_request:
    types: [labeled]     # Run on PR with 'benchmark' label

jobs:
  benchmark:
    # Only run on schedule, dispatch, or PR with 'benchmark' label
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: penshort
          POSTGRES_PASSWORD: penshort
          POSTGRES_DB: penshort
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install migrate CLI
        run: go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Run migrations
        env:
          DATABASE_URL: postgres://penshort:penshort@localhost:5432/penshort?sslmode=disable
        run: migrate -path migrations -database "$DATABASE_URL" up

      - name: Build and start API
        env:
          DATABASE_URL: postgres://penshort:penshort@localhost:5432/penshort?sslmode=disable
          REDIS_URL: redis://localhost:6379
          APP_PORT: 8080
          APP_ENV: test
        run: |
          go build -o bin/api ./cmd/api
          ./bin/api &
          sleep 5
          
          # Wait for ready
          for i in {1..30}; do
            if curl -sf http://localhost:8080/readyz > /dev/null; then
              echo "Service is ready"
              break
            fi
            echo "Waiting for service... ($i/30)"
            sleep 1
          done

      - name: Bootstrap API key
        id: api-key
        env:
          DATABASE_URL: postgres://penshort:penshort@localhost:5432/penshort?sslmode=disable
        run: |
          API_KEY=$(go run ./scripts/bootstrap-api-key.go -database-url "$DATABASE_URL" -format plain)
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT

      - name: Setup benchmark data
        run: |
          chmod +x ./bench/data/setup-links.sh
          ./bench/data/setup-links.sh "${{ steps.api-key.outputs.api_key }}" "http://localhost:8080" 100
        continue-on-error: true

      - name: Create benchmark link
        run: |
          curl -sf -X POST http://localhost:8080/api/v1/links \
            -H "Authorization: Bearer ${{ steps.api-key.outputs.api_key }}" \
            -H "Content-Type: application/json" \
            -d '{"destination": "https://example.com/benchmark", "alias": "bench"}' || true

      - name: Run redirect latency benchmark
        run: |
          k6 run \
            --env BASE_URL=http://localhost:8080 \
            --env API_KEY=${{ steps.api-key.outputs.api_key }} \
            --env SHORT_CODE=bench \
            --out json=bench/results/redirect-latency-${{ github.run_id }}.json \
            bench/scripts/redirect-latency.js
        continue-on-error: true

      - name: Run API benchmark
        run: |
          k6 run \
            --env BASE_URL=http://localhost:8080 \
            --env API_KEY=${{ steps.api-key.outputs.api_key }} \
            --out json=bench/results/api-create-link-${{ github.run_id }}.json \
            bench/scripts/api-create-link.js
        continue-on-error: true

      - name: Run rate limit benchmark
        run: |
          k6 run \
            --env BASE_URL=http://localhost:8080 \
            --env SHORT_CODE=bench \
            --out json=bench/results/redirect-ratelimit-${{ github.run_id }}.json \
            bench/scripts/redirect-ratelimit.js
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.run_id }}
          path: bench/results/*.json
          retention-days: 90

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ðŸ“Š Benchmark Results\n\n';
            comment += '| Metric | Value |\n';
            comment += '|--------|-------|\n';
            comment += '| Run ID | ${{ github.run_id }} |\n';
            comment += '| Commit | ${{ github.sha }} |\n\n';
            comment += 'ðŸ“ Full results available in [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
            comment += '> âš ï¸ Benchmark results are informational only. Thresholds are not enforced on PRs.\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create summary
        run: |
          echo "## Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for result in bench/results/*.json; do
            if [ -f "$result" ]; then
              name=$(basename "$result" .json)
              echo "| $name | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
